<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‹¤ë¦¬ ê±´ë„ˆê¸° í¼ì¦ (ì¾¨ë‹ˆíˆìŠ¤ë² ë¥´í¬ í¬í•¨)</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }
    #game-container {
      display: inline-block;
      position: relative;
    }
    #canvas {
      border: 1px solid #333;
      background: #eef;
      cursor: pointer;
    }
    #info {
      margin-top: 10px;
      max-width: 600px;
      text-align: left;
      font-size: 14px;
    }
    .btn-group {
      margin-top: 10px;
    }
    button {
      margin: 0 4px;
      padding: 6px 10px;
      cursor: pointer;
    }
    /* í¬ê¸° í™•ì¸ìš© ì˜¤ë²„ë ˆì´ */
    #overlay,
    #result-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 600px;
      height: 400px;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      color: #fff;
      z-index: 10;
    }
    .overlay-box {
      background: #ffffff;
      color: #000;
      padding: 16px 20px;
      border-radius: 8px;
      max-width: 520px;
      text-align: left;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    .overlay-box h2 {
      margin-top: 0;
    }
    .overlay-buttons {
      margin-top: 10px;
      text-align: right;
    }
    .overlay-buttons button {
      margin-left: 6px;
    }
    /* ì‹œì‘ í™”ë©´ */
    #start-screen {
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <h1>ë‹¤ë¦¬ ê±´ë„ˆê¸° í¼ì¦</h1>

  <!-- ì‹œì‘ í™”ë©´ -->
  <div id="start-screen">
    <p>
      ì„¬ê³¼ ì„¬ì„ ì‡ëŠ” ë‹¤ë¦¬ë¥¼ <strong>ë”± í•œ ë²ˆì”©ë§Œ</strong> ì§€ë‚˜ê°€ ë³´ì„¸ìš”.<br>
      í•œë¶“ê·¸ë¦¬ê¸°ê°€ ê°€ëŠ¥í•œ ìŠ¤í…Œì´ì§€ë„ ìˆê³ , ë¶ˆê°€ëŠ¥í•œ ìŠ¤í…Œì´ì§€ë„ ìˆìŠµë‹ˆë‹¤.
    </p>
    <button id="start-btn">ì‹œì‘í•˜ê¸°</button>
  </div>

  <!-- ê²Œì„ í™”ë©´ -->
  <div id="game-container" style="display:none;">
    <canvas id="canvas" width="600" height="400"></canvas>

    <!-- í¬ê¸° í™•ì¸ ì˜¤ë²„ë ˆì´ (ìŠ¤í…Œì´ì§€ 5ì—ì„œ ë¦¬ì…‹ 5ë²ˆ ëˆ„ë¥´ë©´ ë“±ì¥) -->
    <div id="overlay">
      <div class="overlay-box">
        <h2>í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
        <p>
          ì´ ìŠ¤í…Œì´ì§€ëŠ” ì•„ë¬´ë¦¬ ì‹œë„í•´ë„ ëª¨ë“  ë‹¤ë¦¬ë¥¼ í•œ ë²ˆì”©ë§Œ ì§€ë‚˜ê°€ëŠ” í•œë¶“ê·¸ë¦¬ê¸°ê°€
          ë˜ì§€ ì•ŠëŠ” ê²ƒì²˜ëŸ¼ ëŠê»´ì§€ë‚˜ìš”?<br>
          ê·¸ë˜ë„ í•œ ë²ˆë§Œ ë” ë„ì „í•´ ë³¼ ìˆ˜ë„ ìˆê³ , ì§€ê¸ˆ í¬ê¸°í•˜ê³  í•´ì„¤ì„ ë³¼ ìˆ˜ë„ ìˆì–´ìš”.
        </p>
        <div class="overlay-buttons">
          <button id="giveup-cancel">ì•„ë‹ˆìš”, ë‹¤ì‹œ ë„ì „í• ë˜ìš”</button>
          <button id="giveup-confirm">ë„¤, í¬ê¸°í•˜ê³  í•´ì„¤ ë³¼ë˜ìš”</button>
        </div>
      </div>
    </div>

    <!-- ê²°ê³¼/í•´ì„¤ ì˜¤ë²„ë ˆì´ (ìŠ¤í…Œì´ì§€ 5 ì „ìš©) -->
    <div id="result-overlay">
      <div class="overlay-box">
        <h2>ì¾¨ë‹ˆíˆìŠ¤ë² ë¥´í¬ì˜ ë‹¤ë¦¬ - ì™œ ëª» ê¹°ê¹Œ?</h2>
        <p>
          ì´ ê·¸ë˜í”„ëŠ” ì—­ì‚¬ì ìœ¼ë¡œ ìœ ëª…í•œ <strong>ì¾¨ë‹ˆíˆìŠ¤ë² ë¥´í¬ì˜ ë‹¤ë¦¬ ë¬¸ì œ</strong>ë¥¼
          ë‹¨ìˆœí™”í•´ì„œ ë§Œë“  ê²ƒì…ë‹ˆë‹¤.<br><br>
          ê·œì¹™ì€ ê°„ë‹¨í–ˆì£ :
        </p>
        <ul>
          <li>ëª¨ë“  ë‹¤ë¦¬ë¥¼ <strong>ë”± í•œ ë²ˆì”©ë§Œ</strong> ì§€ë‚˜ê°„ë‹¤.</li>
          <li>ì–´ë””ì„œ ì‹œì‘í•´ì„œ ì–´ë””ì„œ ëë‚˜ëŠ”ì§€ëŠ” ìƒê´€ ì—†ë‹¤. (í•œë¶“ê·¸ë¦¬ê¸°)</li>
        </ul>
        <p>
          ê·¸ëŸ°ë° ì–´ë–¤ ë‹¤ë¦¬ ë°°ì¹˜ëŠ” ì´ë ‡ê²Œ í•œë¶“ê·¸ë¦¬ê¸°ê°€ ê°€ëŠ¥í•˜ê³ , ì–´ë–¤ ë°°ì¹˜ëŠ” ì ˆëŒ€
          ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
          ê·¸ê±¸ íŒë‹¨í•´ì£¼ëŠ” ê°œë…ì´ ë°”ë¡œ <strong>ì˜¤ì¼ëŸ¬ ê²½ë¡œ / ì˜¤ì¼ëŸ¬ íšŒë¡œ</strong>ì˜ˆìš”.
        </p>
        <p>
          ê° ë•…(ì„¬)ì„ <strong>ì (ì •ì )</strong>ìœ¼ë¡œ, ë‹¤ë¦¬ë¥¼ <strong>ì„ (ê°„ì„ )</strong>ìœ¼ë¡œ
          ë°”ê¾¸ì–´ ìƒê°í•´ë³´ë©´, ê° ì ì—ì„œ ëª‡ ê°œì˜ ì„ ì´ ë‚˜ê°€ëŠ”ì§€(ì°¨ìˆ˜)ë¥¼ ì…‰ë‹ˆë‹¤.
        </p>
        <ul>
          <li>ëª¨ë“  ì ì˜ ì°¨ìˆ˜ê°€ ì§ìˆ˜ì´ë©´ â†’ <strong>ì˜¤ì¼ëŸ¬ íšŒë¡œ</strong> (ì‹œì‘ì ìœ¼ë¡œ ëŒì•„ì˜¤ëŠ” í•œë¶“ê·¸ë¦¬ê¸° ê°€ëŠ¥)</li>
          <li>ì°¨ìˆ˜ê°€ í™€ìˆ˜ì¸ ì ì´ ì •í™•íˆ 2ê°œì´ë©´ â†’ <strong>ì˜¤ì¼ëŸ¬ ê²½ë¡œ</strong> (ì‹œì‘ì ê³¼ ëì ì´ ë‹¤ë¥¸ í•œë¶“ê·¸ë¦¬ê¸° ê°€ëŠ¥)</li>
          <li>ê·¸ ì™¸(í™€ìˆ˜ ì°¨ìˆ˜ ì ì´ 0ê°œë„ 2ê°œë„ ì•„ë‹ˆë©´) â†’ <strong>í•œë¶“ê·¸ë¦¬ê¸° ìì²´ê°€ ë¶ˆê°€ëŠ¥</strong></li>
        </ul>
        <p>
          ì¾¨ë‹ˆíˆìŠ¤ë² ë¥´í¬ì˜ ë‹¤ë¦¬ ê·¸ë˜í”„ëŠ” <strong>í™€ìˆ˜ ì°¨ìˆ˜ ì •ì ì´ 4ê°œ</strong>ì´ê¸° ë•Œë¬¸ì—
          ìœ„ ì¡°ê±´ì— ê±¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
          ê·¸ë˜ì„œ <strong>ìˆ˜í•™ì ìœ¼ë¡œ ì ˆëŒ€ í•œë¶“ê·¸ë¦¬ê¸°ê°€ ë¶ˆê°€ëŠ¥í•œ ê·¸ë˜í”„</strong>ì˜ˆìš”.
        </p>
        <p style="margin-top:8px;">
          ì¦‰, ë‹¹ì‹ ì´ ì´ ìŠ¤í…Œì´ì§€ë¥¼ ëª» ê¹¬ ê²Œ ì•„ë‹ˆë¼,<br>
          <strong>ì• ì´ˆì— ì „ ì„¸ê³„ ëˆ„êµ¬ë„ ì ˆëŒ€ ê¹° ìˆ˜ ì—†ëŠ” ìŠ¤í…Œì´ì§€</strong>ë¥¼ í”Œë ˆì´í•œ ê²ë‹ˆë‹¤ ğŸ˜Š
        </p>
        <div class="overlay-buttons">
          <button id="result-close">ì²˜ìŒ ìŠ¤í…Œì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      </div>
    </div>

    <div id="info"></div>
    <div class="btn-group">
      <button id="reset">í˜„ì¬ ìŠ¤í…Œì´ì§€ ë¦¬ì…‹</button>
      <button id="next" style="display:none;">ë‹¤ìŒ ìŠ¤í…Œì´ì§€</button>
    </div>
  </div>

  <script>
    // ===== ìŠ¤í…Œì´ì§€ ì •ì˜ =====
    // í•œë¶“ê·¸ë¦¬ê¸° ê·œì¹™: "ëª¨ë“  ë‹¤ë¦¬ë¥¼ ì •í™•íˆ í•œ ë²ˆì”©ë§Œ ì§€ë‚˜ë©´ í´ë¦¬ì–´"
    const levels = [
      {
        id: 1,
        title: "Stage 1 - ê¸°ë³¸ ì—°ìŠµ",
        description: "ë…¸ë€ ì„¬ì—ì„œ ì‹œì‘í•´ì„œ ëª¨ë“  ë‹¤ë¦¬ë¥¼ í•œ ë²ˆì”©ë§Œ ì§€ë‚˜ ë³´ì„¸ìš”.",
        nodes: [
          { id: 0, x: 180, y: 120 },
          { id: 1, x: 420, y: 120 },
          { id: 2, x: 420, y: 280 },
          { id: 3, x: 180, y: 280 }
        ],
        edges: [
          // ì‚¬ê°í˜• + ëŒ€ê°ì„  í•˜ë‚˜: í•œë¶“ê·¸ë¦¬ê¸° ê°€ëŠ¥(ë‘ ê°œì˜ í™€ìˆ˜ ì •ì )
          { id: 0, a: 0, b: 1 },
          { id: 1, a: 1, b: 2 },
          { id: 2, a: 2, b: 3 },
          { id: 3, a: 3, b: 0 },
          { id: 4, a: 0, b: 2 }
        ],
        startNode: 0
      },
      {
        id: 2,
        title: "Stage 2 - ë³„ ëª¨ì–‘ ê·¸ë˜í”„",
        description: "ì¤‘ì•™ ì„¬ê³¼ ì£¼ë³€ ì„¬ë“¤ì„ ì—°ê²°í•œ ê·¸ë˜í”„ì…ë‹ˆë‹¤. ëª¨ë“  ë‹¤ë¦¬ë¥¼ í•œ ë²ˆì”©ë§Œ ì§€ë‚˜ ë³´ì„¸ìš”.",
        nodes: [
          { id: 0, x: 300, y: 200 }, // ì¤‘ì•™
          { id: 1, x: 140, y: 120 },
          { id: 2, x: 460, y: 120 },
          { id: 3, x: 460, y: 280 },
          { id: 4, x: 140, y: 280 }
        ],
        edges: [
          // ì¤‘ì•™-ëª¨ì„œë¦¬ 4ê°œ
          { id: 0, a: 0, b: 1 },
          { id: 1, a: 0, b: 2 },
          { id: 2, a: 0, b: 3 },
          { id: 3, a: 0, b: 4 },
          // ë°”ê¹¥ ë„¤ ì ì„ ê±°ì˜ ì‚¬ê°í˜•ì²˜ëŸ¼ ì—°ê²°
          { id: 4, a: 1, b: 2 },
          { id: 5, a: 2, b: 3 },
          { id: 6, a: 3, b: 4 }
        ],
        startNode: 0
      },
      {
        id: 3,
        title: "Stage 3 - ìœ¡ê°í˜• ë¯¸ë¡œ",
        description: "ìœ¡ê°í˜• ëª¨ì–‘ì˜ ì„¬ë“¤ê³¼ ì—¬ëŸ¬ ë‹¤ë¦¬ë¡œ ì´ë£¨ì–´ì§„ ë³µì¡í•œ ê·¸ë˜í”„ì…ë‹ˆë‹¤.",
        nodes: [
          { id: 0, x: 300, y: 80 },
          { id: 1, x: 440, y: 140 },
          { id: 2, x: 440, y: 260 },
          { id: 3, x: 300, y: 320 },
          { id: 4, x: 160, y: 260 },
          { id: 5, x: 160, y: 140 }
        ],
        edges: [
          // ìœ¡ê°í˜• ë§
          { id: 0, a: 0, b: 1 },
          { id: 1, a: 1, b: 2 },
          { id: 2, a: 2, b: 3 },
          { id: 3, a: 3, b: 4 },
          { id: 4, a: 4, b: 5 },
          { id: 5, a: 5, b: 0 },
          // ë‚´ë¶€ ì—°ê²°(ì¡°ê¸ˆ ë” ë³µì¡í•˜ê²Œ)
          { id: 6, a: 0, b: 3 },
          { id: 7, a: 2, b: 5 },
          { id: 8, a: 0, b: 2 }
        ],
        startNode: 0
      },
      {
        id: 4,
        title: "Stage 4 - êµì°¨ ë‹¤ë¦¬",
        description: "ì„œë¡œ êµì°¨í•˜ëŠ” ë‹¤ë¦¬ë“¤ì´ ë§ì€ ê¹Œë‹¤ë¡œìš´ ê·¸ë˜í”„ì…ë‹ˆë‹¤. ëª¨ë“  ë‹¤ë¦¬ë¥¼ í•œ ë²ˆì”©ë§Œ ì§€ë‚˜ ë³´ì„¸ìš”.",
        nodes: [
          { id: 0, x: 140, y: 120 },
          { id: 1, x: 460, y: 120 },
          { id: 2, x: 460, y: 280 },
          { id: 3, x: 140, y: 280 }
        ],
        edges: [
          // ì‚¬ê°í˜• ê¸°ë³¸
          { id: 0, a: 0, b: 1 },
          { id: 1, a: 1, b: 2 },
          { id: 2, a: 2, b: 3 },
          { id: 3, a: 3, b: 0 },
          // ëŒ€ê°ì„  ì—¬ëŸ¬ ê°œ
          { id: 4, a: 0, b: 2 },
          { id: 5, a: 0, b: 2 },
          { id: 6, a: 1, b: 3 },
          { id: 7, a: 1, b: 3 },
          // ì¶”ê°€ ë‹¤ë¦¬ í•˜ë‚˜ë¡œ í™€ìˆ˜ ì •ì  2ê°œ ë§Œë“¤ê¸°
          { id: 8, a: 0, b: 1 }
        ],
        startNode: 0
      },
      {
        id: 5,
        title: "Stage 5 - ì¾¨ë‹ˆíˆìŠ¤ë² ë¥´í¬ì˜ ë‹¤ë¦¬",
        description:
          "ì—­ì‚¬ì ìœ¼ë¡œ ìœ ëª…í•œ 'ì¾¨ë‹ˆíˆìŠ¤ë² ë¥´í¬ì˜ ë‹¤ë¦¬'ë¥¼ ë‹¨ìˆœí™”í•œ ê·¸ë˜í”„ì…ë‹ˆë‹¤. í•œë¶“ê·¸ë¦¬ê¸°ê°€ ê°€ëŠ¥í•œì§€ ì§ì ‘ í•´ë³´ì„¸ìš”.",
        nodes: [
          // ì´ë¯¸ì§€ ëŠë‚Œì„ ì‚´ë¦° ìœ„ìƒë™í˜• ë°°ì¹˜
          { id: 0, x: 300, y: 200 }, // ì¤‘ì•™ ì„¬ C
          { id: 1, x: 170, y: 130 }, // ì™¼ìª½ ìœ¡ì§€ A
          { id: 2, x: 430, y: 130 }, // ì˜¤ë¥¸ìª½ ìœ¡ì§€ D
          { id: 3, x: 300, y: 310 }  // ì•„ë˜ ìœ¡ì§€ B
        ],
        edges: [
          // ì¾¨ë‹ˆíˆìŠ¤ë² ë¥´í¬ ê·¸ë˜í”„ êµ¬ì¡° ë™ì¼ (7ê°œì˜ ë‹¤ë¦¬)
          { id: 0, a: 0, b: 1 },
          { id: 1, a: 0, b: 1 },
          { id: 2, a: 0, b: 2 },
          { id: 3, a: 0, b: 2 },
          { id: 4, a: 0, b: 3 },
          { id: 5, a: 1, b: 3 },
          { id: 6, a: 2, b: 3 }
        ],
        startNode: 0
      }
    ];

    // ===== ê³µí†µ ìƒíƒœ =====
    const startScreen = document.getElementById("start-screen");
    const startBtn = document.getElementById("start-btn");
    const gameContainer = document.getElementById("game-container");

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const infoDiv = document.getElementById("info");
    const nextBtn = document.getElementById("next");
    const resetBtn = document.getElementById("reset");

    const overlay = document.getElementById("overlay");
    const giveupCancelBtn = document.getElementById("giveup-cancel");
    const giveupConfirmBtn = document.getElementById("giveup-confirm");

    const resultOverlay = document.getElementById("result-overlay");
    const resultCloseBtn = document.getElementById("result-close");

    let currentLevelIndex = 0;
    let usedEdges = {}; // edgeId -> true/false
    let currentNodeId = null;
    let startNodeId = null;
    let levelCleared = false;

    // ìŠ¤í…Œì´ì§€ 5 ë¦¬ì…‹ ëˆ„ë¥¸ íšŸìˆ˜
    let stage5ResetCount = 0;

    // ì¹˜íŠ¸ìš© í”Œë˜ê·¸ (` í‚¤ë¥¼ ë§ˆì§€ë§‰ì— ëˆŒë €ëŠ”ì§€)
    let cheatArmed = false;

    // ===== í˜„ì¬ ë ˆë²¨ =====
    function getCurrentLevel() {
      return levels[currentLevelIndex];
    }

    // ===== í‰í–‰ ë‹¤ë¦¬ offsetIndex ì„¸íŒ… =====
    function prepareParallelOffsets(level) {
      const map = {};
      level.edges.forEach(e => {
        const key = e.a < e.b ? `${e.a}-${e.b}` : `${e.b}-${e.a}`;
        if (!map[key]) map[key] = [];
        map[key].push(e);
      });

      Object.values(map).forEach(edgesArr => {
        const n = edgesArr.length;
        if (n === 1) {
          edgesArr[0].offsetIndex = 0;
        } else {
          for (let i = 0; i < n; i++) {
            edgesArr[i].offsetIndex = i - (n - 1) / 2;
          }
        }
      });
    }

    // ===== ë ˆë²¨ ì´ˆê¸°í™” =====
    function initLevel(index) {
      currentLevelIndex = index;
      const level = getCurrentLevel();

      usedEdges = {};
      level.edges.forEach(e => {
        usedEdges[e.id] = false;
      });

      startNodeId = level.startNode;
      currentNodeId = startNodeId;
      levelCleared = false;

      // ìŠ¤í…Œì´ì§€ 5 ë¦¬ì…‹ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
      if (level.id === 5) {
        stage5ResetCount = 0;
      }

      prepareParallelOffsets(level);

      draw();
      updateInfo();

      // 1~4 ìŠ¤í…Œì´ì§€ë§Œ ë‹¤ìŒ ë²„íŠ¼, í´ë¦¬ì–´ í›„ì—ë§Œ ë³´ì´ê²Œ
      if (level.id <= 4) {
        nextBtn.style.display = levelCleared ? "inline-block" : "none";
      } else {
        nextBtn.style.display = "none";
      }
    }

    // ===== ê°•/ë°°ê²½ ê·¸ë¦¬ê¸° =====
    function drawRiver(level) {
      ctx.save();
      ctx.fillStyle = "#b0d8ff";

      if (level.id === 1) {
        // ì‚¬ê°í˜• ì‚¬ì´ë¥¼ ê°€ë¡œì§€ë¥´ëŠ” ê°•
        ctx.beginPath();
        ctx.moveTo(100, 160);
        ctx.quadraticCurveTo(300, 140, 500, 160);
        ctx.lineTo(500, 220);
        ctx.quadraticCurveTo(300, 240, 100, 220);
        ctx.closePath();
        ctx.fill();
      } else if (level.id === 2) {
        // ì¤‘ì•™ì—ì„œ ëŒ€ê°ì„ ìœ¼ë¡œ íë¥´ëŠ” ê°•
        ctx.beginPath();
        ctx.moveTo(80, 180);
        ctx.quadraticCurveTo(300, 150, 520, 180);
        ctx.lineTo(520, 230);
        ctx.quadraticCurveTo(300, 260, 80, 230);
        ctx.closePath();
        ctx.fill();
      } else if (level.id === 3) {
        // ìœ¡ê°í˜• ì£¼ë³€ì„ ë„ëŠ” ê°•
        ctx.beginPath();
        ctx.moveTo(120, 90);
        ctx.quadraticCurveTo(300, 40, 480, 90);
        ctx.quadraticCurveTo(540, 200, 480, 310);
        ctx.quadraticCurveTo(300, 360, 120, 310);
        ctx.quadraticCurveTo(60, 200, 120, 90);
        ctx.closePath();
        ctx.fill();
      } else if (level.id === 4) {
        // ì‚¬ê°í˜•ì„ ê°ì‹¸ëŠ” ê°•
        ctx.beginPath();
        ctx.moveTo(80, 80);
        ctx.quadraticCurveTo(300, 40, 520, 80);
        ctx.lineTo(520, 320);
        ctx.quadraticCurveTo(300, 360, 80, 320);
        ctx.closePath();
        ctx.fill();
      } else if (level.id === 5) {
        // ì¾¨ë‹ˆíˆìŠ¤ë² ë¥´í¬ ëŠë‚Œ: ìœ„/ì•„ë˜ ë‘ ì¤„ ê°• + ì¤‘ì•™ ì„¬ ì£¼ë³€ ê³¡ì„ 
        // ìœ„ìª½ ê°•
        ctx.beginPath();
        ctx.moveTo(40, 120);
        ctx.quadraticCurveTo(300, 80, 560, 120);
        ctx.lineTo(560, 160);
        ctx.quadraticCurveTo(300, 120, 40, 160);
        ctx.closePath();
        ctx.fill();
        // ì•„ë˜ìª½ ê°•
        ctx.beginPath();
        ctx.moveTo(40, 240);
        ctx.quadraticCurveTo(300, 200, 560, 240);
        ctx.lineTo(560, 280);
        ctx.quadraticCurveTo(300, 240, 40, 280);
        ctx.closePath();
        ctx.fill();
      }

      ctx.restore();
    }

    // ===== ê·¸ë¦¬ê¸° (ê³¡ì„  ë‹¤ë¦¬ + ê°•) =====
    function draw() {
      const level = getCurrentLevel();
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ê°•/ë°°ê²½ ë¨¼ì €
      drawRiver(level);

      // ë‹¤ë¦¬(ê°„ì„ ) - ê³¡ì„ ìœ¼ë¡œ ê·¸ë¦¬ê¸°
      level.edges.forEach(e => {
        const nodeA = level.nodes.find(n => n.id === e.a);
        const nodeB = level.nodes.find(n => n.id === e.b);

        const ax = nodeA.x;
        const ay = nodeA.y;
        const bx = nodeB.x;
        const by = nodeB.y;

        const mx = (ax + bx) / 2;
        const my = (ay + by) / 2;

        const dx = bx - ax;
        const dy = by - ay;
        const len = Math.sqrt(dx * dx + dy * dy) || 1;
        const nx = -dy / len;
        const ny = dx / len;

        const offsetIndex = e.offsetIndex || 0;
        // ê¸°ë³¸ ê³¡ë¥  + í‰í–‰ ë‹¤ë¦¬ëŠ” ë” ë§ì´ íœ˜ê²Œ
        const baseCurve = 18;
        const curveAmount = baseCurve * (1 + Math.abs(offsetIndex));

        const cx = mx + nx * curveAmount * (offsetIndex === 0 ? 0.5 : offsetIndex);
        const cy = my + ny * curveAmount * (offsetIndex === 0 ? 0.5 : offsetIndex);

        ctx.beginPath();
        ctx.moveTo(ax, ay);
        ctx.quadraticCurveTo(cx, cy, bx, by);
        ctx.strokeStyle = usedEdges[e.id] ? "#999999" : "#004488";
        ctx.lineWidth = 5;
        ctx.stroke();
      });

      // ì„¬(ë…¸ë“œ)
      level.nodes.forEach(n => {
        const isCurrent = n.id === currentNodeId;
        ctx.beginPath();
        ctx.arc(n.x, n.y, 18, 0, Math.PI * 2);
        ctx.fillStyle = isCurrent ? "#ffcc00" : "#ffffff"; // í˜„ì¬ ìœ„ì¹˜ ë…¸ë‘
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#333333";
        ctx.stroke();

        ctx.fillStyle = "#000000";
        ctx.font = "14px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(n.id, n.x, n.y);
      });
    }

    // ===== ì •ë³´ UI =====
    function updateInfo(message) {
      const level = getCurrentLevel();
      const totalEdges = level.edges.length;
      const usedCount = Object.values(usedEdges).filter(v => v).length;

      let html = `
        <div><strong>${level.title}</strong></div>
        <div style="margin-top:4px;">${level.description}</div>
        <div style="margin-top:4px;">í˜„ì¬ ìŠ¤í…Œì´ì§€: ${level.id} / ${levels.length}</div>
        <div>ì‚¬ìš©í•œ ë‹¤ë¦¬: ${usedCount} / ${totalEdges}</div>
        <div>í˜„ì¬ ìœ„ì¹˜í•œ ì„¬ ID: ${currentNodeId}</div>
        <div style="margin-top:4px; font-size: 13px; color:#555;">
          ê·œì¹™: ëª¨ë“  ë‹¤ë¦¬ë¥¼ <strong>ë”± í•œ ë²ˆì”©ë§Œ</strong> ì§€ë‚˜ë©´ í´ë¦¬ì–´ì…ë‹ˆë‹¤. ì¶œë°œì§€ë¡œ ëŒì•„ì˜¬ í•„ìš”ëŠ” ì—†ì–´ìš”.
        </div>
      `;

      if (levelCleared && level.id <= 4) {
        html += `<div style="margin-top:6px; color:#006600;"><strong>âœ” í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤! 'ë‹¤ìŒ ìŠ¤í…Œì´ì§€' ë²„íŠ¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></div>`;
      }

      if (message) {
        html += `<div style="margin-top:6px; color:#c00;"><strong>${message}</strong></div>`;
      }

      infoDiv.innerHTML = html;
    }

    // ===== ìŠ¹ë¦¬ ì¡°ê±´ ì²´í¬ (í•œë¶“ê·¸ë¦¬ê¸°: ëª¨ë“  ë‹¤ë¦¬ ì‚¬ìš©) =====
    function checkWin() {
      const level = getCurrentLevel();
      const totalEdges = level.edges.length;
      const usedCount = Object.values(usedEdges).filter(v => v).length;

      if (usedCount === totalEdges) {
        levelCleared = true;
        updateInfo("ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ë‹¤ë¦¬ë¥¼ í•œ ë²ˆì”©ë§Œ ì§€ë‚˜ê°”ìŠµë‹ˆë‹¤! âœ…");
        // 1~4 ìŠ¤í…Œì´ì§€ì¼ ë•Œë§Œ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ë²„íŠ¼ ë“±ì¥
        if (level.id <= 4) {
          nextBtn.style.display = "inline-block";
        }
        return true;
      }
      return false;
    }

    // ===== ë…¸ë“œ í´ë¦­ ì²˜ë¦¬ =====
    function onCanvasClick(event) {
      const level = getCurrentLevel();
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      const clickedNode = level.nodes.find(n => {
        const dx = x - n.x;
        const dy = y - n.y;
        return Math.sqrt(dx * dx + dy * dy) <= 20;
      });

      if (!clickedNode) {
        return;
      }

      if (clickedNode.id === currentNodeId) {
        updateInfo("ì´ë¯¸ ê·¸ ì„¬ì— ì„œ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì„¬ì„ ëˆŒëŸ¬ ë³´ì„¸ìš”.");
        return;
      }

      const candidateEdges = level.edges.filter(e => {
        const connected =
          (e.a === currentNodeId && e.b === clickedNode.id) ||
          (e.b === currentNodeId && e.a === clickedNode.id);
        return connected && !usedEdges[e.id];
      });

      if (candidateEdges.length === 0) {
        updateInfo("ì´ ë‘ ì„¬ ì‚¬ì´ì— ë” ì´ìƒ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¤ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const edgeToUse = candidateEdges[0];
      usedEdges[edgeToUse.id] = true;
      currentNodeId = clickedNode.id;

      draw();
      if (!checkWin()) {
        updateInfo();
      }
    }

    // ===== ì¹˜íŠ¸ ê¸°ëŠ¥ =====
    // ` + Enter  â†’ ìë™ í´ë¦¬ì–´
    // ` + â†      â†’ ì´ì „ ìŠ¤í…Œì´ì§€
    // ` + â†’      â†’ ë‹¤ìŒ ìŠ¤í…Œì´ì§€
    function cheatAutoClear() {
      const level = getCurrentLevel();
      level.edges.forEach(e => {
        usedEdges[e.id] = true;
      });
      draw();
      checkWin(); // 5ìŠ¤í…Œì´ì§€ë„ ê·¸ëƒ¥ "í´ë¦¬ì–´ëœ ê²ƒì²˜ëŸ¼" ì²˜ë¦¬ë¨ (ì¹˜íŠ¸ë‹ˆê¹Œ)
    }

    function cheatGoPrev() {
      let idx = currentLevelIndex - 1;
      if (idx < 0) idx = levels.length - 1;
      initLevel(idx);
    }

    function cheatGoNext() {
      let idx = currentLevelIndex + 1;
      if (idx >= levels.length) idx = 0;
      initLevel(idx);
    }

    document.addEventListener("keydown", (e) => {
      // ê²Œì„ ì‹œì‘ ì „ì—ëŠ” ì¹˜íŠ¸ ë¬´ì‹œ
      if (gameContainer.style.display === "none") return;

      if (e.key === "`") {
        cheatArmed = true;
        return;
      }

      if (!cheatArmed) return;

      if (e.key === "Enter") {
        cheatAutoClear();
      } else if (e.key === "ArrowLeft") {
        cheatGoPrev();
      } else if (e.key === "ArrowRight") {
        cheatGoNext();
      }

      cheatArmed = false;
    });

    // ===== ë²„íŠ¼ ì´ë²¤íŠ¸ =====
    nextBtn.addEventListener("click", () => {
      const level = getCurrentLevel();
      if (!levelCleared || level.id >= 5) {
        return;
      }
      let nextIndex = currentLevelIndex + 1;
      if (nextIndex >= levels.length) nextIndex = 0;
      initLevel(nextIndex);
    });

    resetBtn.addEventListener("click", () => {
      const level = getCurrentLevel();

      if (level.id === 5) {
        stage5ResetCount++;
        if (stage5ResetCount >= 5) {
          // í¬ê¸° ì˜¤ë²„ë ˆì´ ë„ìš°ê¸°
          overlay.style.display = "flex";
        }
      }

      initLevel(currentLevelIndex);
    });

    canvas.addEventListener("click", onCanvasClick);

    // ===== í¬ê¸° ì˜¤ë²„ë ˆì´ ë²„íŠ¼ =====
    giveupCancelBtn.addEventListener("click", () => {
      overlay.style.display = "none";
    });

    giveupConfirmBtn.addEventListener("click", () => {
      overlay.style.display = "none";
      // ê²°ê³¼/í•´ì„¤ ì˜¤ë²„ë ˆì´ ë„ìš°ê¸°
      resultOverlay.style.display = "flex";
    });

    // ===== ê²°ê³¼/í•´ì„¤ ì˜¤ë²„ë ˆì´ ë²„íŠ¼ =====
    resultCloseBtn.addEventListener("click", () => {
      resultOverlay.style.display = "none";
      // ì²˜ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™
      initLevel(0);
    });

    // ===== ì‹œì‘ ë²„íŠ¼ =====
    startBtn.addEventListener("click", () => {
      startScreen.style.display = "none";
      gameContainer.style.display = "inline-block";
      initLevel(0);
    });
  </script>
</body>
</html>
