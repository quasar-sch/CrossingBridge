<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>다리 건너기 퍼즐</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }
    #game-container {
      display: inline-block;
      position: relative;
    }
    #canvas {
      border: 1px solid #333;
      background: #eef;
      cursor: pointer;
    }
    #info {
      margin-top: 10px;
      max-width: 600px;
      text-align: left;
      font-size: 14px;
    }
    .btn-group {
      margin-top: 10px;
    }
    button {
      margin: 0 4px;
      padding: 6px 10px;
      cursor: pointer;
    }
    /* 오버레이 */
    #overlay,
    #result-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 600px;
      height: 400px;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      color: #fff;
      z-index: 10;
    }
    .overlay-box {
      background: #ffffff;
      color: #000;
      padding: 16px 20px;
      border-radius: 8px;
      max-width: 520px;
      text-align: left;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .overlay-buttons {
      margin-top: 10px;
      text-align: right;
    }
    /* 시작 화면 */
    #start-screen {
      margin-top: 40px;
    }
  </style>
</head>
<body>

<h1>다리 건너기 퍼즐</h1>

<!-- 시작 화면 -->
<div id="start-screen">
  <p>
    섬과 섬을 잇는 다리를 <strong>딱 한 번씩만</strong> 지나가 보세요.<br>
    한붓그리기가 가능한 스테이지도 있고, 불가능한 스테이지도 있습니다.
  </p>
  <button id="start-btn">시작하기</button>
</div>

<!-- 게임 화면 -->
<div id="game-container" style="display:none;">
  <canvas id="canvas" width="600" height="400"></canvas>

  <!-- 포기 확인 -->
  <div id="overlay">
    <div class="overlay-box">
      <h2>포기하시겠습니까?</h2>
      <p>
        이 스테이지는 수학적으로도 한붓그리기가 불가능한 그래프입니다.<br>
        지금 포기하고 해설을 볼 수 있습니다.
      </p>
      <div class="overlay-buttons">
        <button id="giveup-cancel">아니요</button>
        <button id="giveup-confirm">네, 해설 보기</button>
      </div>
    </div>
  </div>

  <!-- 스테이지 5 해설 -->
  <div id="result-overlay">
    <div class="overlay-box">
      <h2>쾨니히스베르크의 다리 - 왜 못 깰까?</h2>
      <p>
        이 그래프는 역사적으로 유명한 '쾨니히스베르크의 다리' 문제입니다.
        모든 다리를 <strong>한 번씩만</strong> 지나가고 싶었지만,
        실제로는 불가능합니다.
      </p>
      <p>홀수 차수 정점이 4개 → 한붓그리기 절대 불가능</p>
      <div class="overlay-buttons">
        <button id="result-close">처음 스테이지로</button>
      </div>
    </div>
  </div>

  <div id="info"></div>
  <div class="btn-group">
    <button id="reset">현재 스테이지 리셋</button>
    <button id="next" style="display:none;">다음 스테이지</button>
  </div>
</div>

<script>
/* ===========================
    스테이지 설정
=========================== */
const levels = [
  {
    id: 1,
    title: "Stage 1 - 기본 연습",
    description: "가장 단순한 구조입니다.",
    nodes: [
      { id: 0, x: 180, y: 120 },
      { id: 1, x: 420, y: 120 },
      { id: 2, x: 420, y: 280 },
      { id: 3, x: 180, y: 280 }
    ],
    edges: [
      { id: 0, a:0, b:1 },
      { id: 1, a:1, b:2 },
      { id: 2, a:2, b:3 },
      { id: 3, a:3, b:0 },
      { id: 4, a:0, b:2 }
    ],
    startNode: 0
  },

  {
    id: 2,
    title: "Stage 2 - 별 모양 그래프",
    description: "스타형 그래프.",
    nodes: [
      { id: 0, x:300, y:200 },
      { id: 1, x:140, y:120 },
      { id: 2, x:460, y:120 },
      { id: 3, x:460, y:280 },
      { id: 4, x:140, y:280 }
    ],
    edges: [
      { id:0, a:0, b:1 },
      { id:1, a:0, b:2 },
      { id:2, a:0, b:3 },
      { id:3, a:0, b:4 },
      { id:4, a:1, b:2 },
      { id:5, a:2, b:3 },
      { id:6, a:3, b:4 }
    ],
    startNode: 2   // ★ 수정
  },

  {
    id: 3,
    title: "Stage 3 - 육각형 미로",
    description: "복잡한 육각 구조.",
    nodes: [
      { id:0, x:300, y:80 },
      { id:1, x:440, y:140 },
      { id:2, x:440, y:260 },
      { id:3, x:300, y:320 },
      { id:4, x:160, y:260 },
      { id:5, x:160, y:140 }
    ],
    edges: [
      { id:0, a:0,b:1 },
      { id:1, a:1,b:2 },
      { id:2, a:2,b:3 },
      { id:3, a:3,b:4 },
      { id:4, a:4,b:5 },
      { id:5, a:5,b:0 },
      { id:6, a:0,b:3 },
      { id:7, a:2,b:5 },
      { id:8, a:0,b:2 }
    ],
    startNode: 3   // ★ 수정
  },

  {
    id: 4,
    title: "Stage 4 - 교차 다리",
    description: "많은 교차 다리.",
    nodes: [
      { id:0, x:140, y:120 },
      { id:1, x:460, y:120 },
      { id:2, x:460, y:280 },
      { id:3, x:140, y:280 }
    ],
    edges: [
      { id:0, a:0,b:1 },
      { id:1, a:1,b:2 },
      { id:2, a:2,b:3 },
      { id:3, a:3,b:0 },
      { id:4, a:0,b:2 },
      { id:5, a:0,b:2 },
      { id:6, a:1,b:3 },
      { id:7, a:1,b:3 },
      { id:8, a:0,b:1 }
    ],
    startNode: 0
  },

  {
    id: 5,
    title: "Stage 5 - 쾨니히스베르크",
    description: "역사적 난제, 절대 못 깨는 스테이지.",
    nodes: [
      { id:0, x:300, y:160 }, // 중앙 C
      { id:1, x:160, y:110 }, // 왼쪽 A
      { id:2, x:440, y:110 }, // 오른쪽 D
      { id:3, x:300, y:290 }  // 아래 B
    ],
    edges: [
      { id:0, a:0,b:1 },
      { id:1, a:0,b:1 },
      { id:2, a:0,b:2 },
      { id:3, a:0,b:2 },
      { id:4, a:0,b:3 },
      { id:5, a:1,b:3 },
      { id:6, a:2,b:3 }
    ],
    startNode: 0
  }
];

/* ===============================
   전역 상태
================================*/
const startScreen = document.getElementById("start-screen");
const startBtn    = document.getElementById("start-btn");

const gameContainer = document.getElementById("game-container");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const nextBtn  = document.getElementById("next");
const resetBtn = document.getElementById("reset");

const overlay        = document.getElementById("overlay");
const giveupCancel   = document.getElementById("giveup-cancel");
const giveupConfirm  = document.getElementById("giveup-confirm");

const resultOverlay  = document.getElementById("result-overlay");
const resultClose    = document.getElementById("result-close");

const infoDiv = document.getElementById("info");

let currentLevelIndex = 0;
let usedEdges = {};
let currentNodeId = null;
let levelCleared = false;
let resetCount = 0;

let cheatArmed = false;

/* ===============================
   초기화
================================*/
function getLevel() {
  return levels[currentLevelIndex];
}

function initLevel(index) {
  currentLevelIndex = index;
  const level = getLevel();

  usedEdges = {};
  level.edges.forEach(e => usedEdges[e.id] = false);

  currentNodeId = level.startNode;
  levelCleared = false;
  resetCount = 0;

  draw();
  updateInfo();
  nextBtn.style.display = "none";
}

/* ===============================
   곡선 다리 그리기
================================*/
function drawCurveEdge(x1,y1,x2,y2,offset=0){
  const mx = (x1+x2)/2;
  const my = (y1+y2)/2;

  const dx = x2-x1;
  const dy = y2-y1;
  const len = Math.sqrt(dx*dx + dy*dy) || 1;

  const nx = -dy/len;
  const ny = dx/len;

  const curve = 20 * (offset+1);

  const cx = mx + nx * curve;
  const cy = my + ny * curve;

  ctx.quadraticCurveTo(cx, cy, x2, y2);
}

/* ===============================
   강 모양 (스테이지 별)
================================*/
function drawRiver(level){
  ctx.save();
  ctx.fillStyle = "#b6e3ff";

  if(level.id===5){
    // 위 강
    ctx.beginPath();
    ctx.moveTo(40,100);
    ctx.quadraticCurveTo(300, 60, 560,100);
    ctx.lineTo(560,140);
    ctx.quadraticCurveTo(300,110,40,140);
    ctx.closePath();
    ctx.fill();

    // 아래 강
    ctx.beginPath();
    ctx.moveTo(40,220);
    ctx.quadraticCurveTo(300,180,560,220);
    ctx.lineTo(560,260);
    ctx.quadraticCurveTo(300,230,40,260);
    ctx.closePath();
    ctx.fill();
  }
  else {
    ctx.beginPath();
    ctx.moveTo(80,140);
    ctx.quadraticCurveTo(300,110,520,140);
    ctx.lineTo(520,260);
    ctx.quadraticCurveTo(300,290,80,260);
    ctx.closePath();
    ctx.fill();
  }
  ctx.restore();
}

/* ===============================
   전체 그리기
================================*/
function draw(){
  const level = getLevel();
  ctx.clearRect(0,0,600,400);

  drawRiver(level);

  // 다리
  level.edges.forEach(e=>{
    const A = level.nodes.find(n=>n.id===e.a);
    const B = level.nodes.find(n=>n.id===e.b);

    ctx.beginPath();
    ctx.moveTo(A.x, A.y);

    const offset = e.offsetIndex || 0;
    ctx.lineWidth = 5;
    ctx.strokeStyle = usedEdges[e.id] ? "#999" : "#004488";

    drawCurveEdge(A.x, A.y, B.x, B.y, offset);
    ctx.stroke();
  });

  // 섬
  level.nodes.forEach(n=>{
    ctx.beginPath();
    ctx.arc(n.x, n.y, 18, 0, Math.PI*2);
    ctx.fillStyle = (n.id===currentNodeId) ? "#ffdd55" : "#fff";
    ctx.fill();
    ctx.strokeStyle="#333";
    ctx.lineWidth=2;
    ctx.stroke();

    ctx.fillStyle="#000";
    ctx.font="14px sans-serif";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(n.id, n.x, n.y);
  });
}

/* ===============================
   정보 출력
================================*/
function updateInfo(msg=""){
  const level = getLevel();
  const total = level.edges.length;
  const used  = Object.values(usedEdges).filter(v=>v).length;

  let txt = `
    <strong>${level.title}</strong><br>
    ${level.description}<br><br>
    사용한 다리: ${used} / ${total}<br>
    현재 위치한 섬: ${currentNodeId}<br>
  `;
  if(msg) txt += `<p style="color:#c00">${msg}</p>`;

  if(levelCleared && level.id <=4){
    txt += `<p style="color:#007700;"><strong>클리어! 다음 스테이지 버튼 활성화!</strong></p>`;
  }

  infoDiv.innerHTML = txt;
}

/* ===============================
   승리 조건 체크
================================*/
function checkWin(){
  const level = getLevel();
  const total = level.edges.length;
  const used  = Object.values(usedEdges).filter(v=>v).length;

  if(used===total){
    levelCleared = true;
    updateInfo("축하합니다! 모든 다리를 지나갔습니다!");
    if(level.id<=4) nextBtn.style.display="inline-block";
    return true;
  }
  return false;
}

/* ===============================
   노드 클릭
================================*/
canvas.addEventListener("click", ev=>{
  const level = getLevel();
  const rect  = canvas.getBoundingClientRect();
  const x = ev.clientX - rect.left;
  const y = ev.clientY - rect.top;

  const clicked = level.nodes.find(n=>Math.hypot(n.x-x, n.y-y)<=20);
  if(!clicked) return;

  if(clicked.id === currentNodeId){
    updateInfo("이미 그 섬입니다.");
    return;
  }

  const usable = level.edges.filter(e=>{
    const c =
      (e.a===currentNodeId && e.b===clicked.id) ||
      (e.b===currentNodeId && e.a===clicked.id);
    return c && !usedEdges[e.id];
  });

  if(usable.length===0){
    updateInfo("사용 가능한 다리가 없습니다.");
    return;
  }

  const edge = usable[0];
  usedEdges[edge.id] = true;
  currentNodeId = clicked.id;

  draw();
  if(!checkWin()) updateInfo();
});

/* ===============================
   치트 기능 (` + Enter)
================================*/
function animateClear(){
  const level = getLevel();
  let i = 0;

  function step(){
    if(i>=level.edges.length){
      checkWin();
      return;
    }
    usedEdges[level.edges[i].id] = true;
    draw();
    i++;
    setTimeout(step, 150);
  }
  step();
}

document.addEventListener("keydown",e=>{
  if(gameContainer.style.display==="none") return;

  if(e.key==="`"){
    cheatArmed = true;
    return;
  }
  if(!cheatArmed) return;

  if(e.key==="Enter"){
    animateClear();
  }else if(e.key==="ArrowLeft"){
    initLevel((currentLevelIndex-1+levels.length)%levels.length);
  }else if(e.key==="ArrowRight"){
    initLevel((currentLevelIndex+1)%levels.length);
  }

  cheatArmed = false;
});

/* ===============================
   리셋 버튼 (스테이지 5 포기)
================================*/
resetBtn.addEventListener("click", ()=>{
  const level = getLevel();

  if(level.id===5){
    resetCount++;
    if(resetCount>=5){
      overlay.style.display="flex";
      return;
    }
  }
  initLevel(currentLevelIndex);
});

/* 포기창 */
giveupCancel.addEventListener("click", ()=>{
  overlay.style.display="none";
});
giveupConfirm.addEventListener("click", ()=>{
  overlay.style.display="none";
  resultOverlay.style.display="flex";
});

/* 해설창 */
resultClose.addEventListener("click", ()=>{
  resultOverlay.style.display="none";
  initLevel(0);
});

/* ===============================
   시작 버튼
================================*/
startBtn.addEventListener("click", ()=>{
  startScreen.style.display="none";
  gameContainer.style.display="inline-block";
  initLevel(0);
});

</script>
</body>
</html>
